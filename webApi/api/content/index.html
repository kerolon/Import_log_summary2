<html>

<head>
    <title>batch_summary</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.1.3/dist/css/bootstrap.min.css">
    <script>
        window.apiBaseUrl = window.location.origin;
    </script>
    <style>
        .slide-fade-enter-active,
        .slide-fade-leave-active {
            transition: all 1s ease;
        }

        .slide-fade-enter,
        .slide-fade-leave-to {
            height: 0px;
            overflow-y: hidden;
            opacity: 0;
        }
    </style>
</head>

<body>
  <p>&nbsp;</p>
  <div id="app" class="container">
      <div class="row" v-if="!ready">
          <div class="col-sm">
              <div>Loading...</div>
          </div>
      </div>
      <div class="row" v-if="ready">
          <div class="col-sm">
              <div class="container">
                  <div class="filter pos-left">
                      <select name="ddlInfoTypeFilter" id="ddlInfoTypeFilter">
                          <option label="--filter--" value=""></option>
                          <option v-for="filter in filters" v-bind:key="filter.id" v-bind:label=filter.name v-bind:value=filter.val></option>
                      </select>
                  </div>
                  <div class="order pos-left pad-left">
                      <select name="ddlOrder" id="ddlOrder">
                          <option v-bind:label="headerName.date" value="0"></option>
                          <option v-bind:label="headerName.sub_name" value="1"></option>
                          <option v-bind:label="headerName.name" value="2"></option>
                      </select>
                  </div>
                  <div class="table-responsive">
                      <table id="main" class="table table-striped table-borderd table-hover">
                          <thead>
                              <tr>
                                  <td id="date_head">
                                      {{headerName.date}}
                                  </td>
                                  <td id="infoType_head">
                                      {{headerName.info_type}}
                                  </td>
                                  <td id="name_head">
                                      {{headerName.name}}
                                  </td>
                                  <td id="subName_head">
                                      {{headerName.sub_name}}
                                  </td>
                                  <td id="description_head">
                                      {{headerName.description}}
                                  </td>
                              </tr>
                          </thead>
                          <tbody>
                              <tr class="log" v-for="log in logs" v-bind:key="log.log_id">
                                  <td class="clickable">
                                      {{log.date}}
                                  </td>
                                  <td class="clickable">
                                      {{log.info_type}}
                                  </td>
                                  <td class="clickable">
                                      {{log.name}}
                                  </td>
                                  <td class="clickable">
                                      {{log.sub_name}}
                                  </td>
                                  <td>
                                      <div class="limit-height vscroll descript" log-id={{log.log_id}}>
                                          {{log.description}}
                                      </div>
                                  </td>
                              </tr>
                          </tbody>
                      </table>
                  </div>
              </div>
          </div>
      </div>
      <script src="https://cdn.jsdelivr.net/npm/vue@2.5.17/dist/vue.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/@aspnet/signalr@1.0.3/dist/browser/signalr.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/axios@0.18.0/dist/axios.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/crypto-js@3.1.9-1/crypto-js.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/crypto-js@3.1.9-1/enc-base64.js"></script>
      <script>
          const headerName = {
              date: 'Date',
              info_type: 'Info Type',
              name: 'Name',
              sub_name: 'Sub Name',
              description: 'Description',
          }
          const data = {
              username: '',
              defaultgroup: 'AzureSignalR',
              checked: false,
              newMessage: '',
              logs: [],
              filters:[],
              myConnectionId: '',
              ready: false,
              headerName: headerName,
          };
          const app = new Vue({
              el: '#app',
              data: data,
              methods: {
                  sendNewMessage: function () {
                      connection.invoke("broadcast", this.newMessage);
                      this.newMessage = '';
                  }
              }
          });
          const apiBaseUrl = window.apiBaseUrl; //prompt('Enter the Azure Function app base URL', window.apiBaseUrl);
          data.username = prompt("Enter your username");
          const isAdmin = confirm('Work as administrator? (only an administrator can broadcast messages)');
          if (!data.username) {
              alert("No username entered. Reload page and try again.");
              throw "No username entered";
          }
          const connection = new signalR.HubConnectionBuilder()
              .withUrl(apiBaseUrl + '/api', {
                  accessTokenFactory: () => {
                      return generateAccessToken(data.username)
                  }
              })
              .configureLogging(signalR.LogLevel.Information)
              .build();
          connection.on('newMessage', onNewMessage);
          connection.on('newConnection', onNewConnection)
          connection.onclose(() => console.log('disconnected'));
          console.log('connecting...');
          connection.start()
              .then(() => {
                  data.ready = true;
                  console.log('connected!');
              })
              .catch(console.error);
          let counter = 0;
          function onNewMessage(messages) {
              if (messages) {
                  data.logs = messages.map(message => {
                      return {
                          log_id: message.Id,
                          date: message.DateTime,
                          info_type: message.Type,
                          name: message.Name,
                          sub_name: message.From,
                          description: message.Description
                      }
                  });
                  filters = Array.from(new Map(data.logs.map(l => [l.info_type, { name: l.info_type, val: l.info_type }])).values());
              }
              
          };
          function onNewConnection(message) {
              data.myConnectionId = message.ConnectionId;
              onNewMessage(message);
          }

          function base64url(source) {
              // Encode in classical base64
              encodedSource = CryptoJS.enc.Base64.stringify(source);

              // Remove padding equal characters
              encodedSource = encodedSource.replace(/=+$/, '');

              // Replace characters according to base64url specifications
              encodedSource = encodedSource.replace(/\+/g, '-');
              encodedSource = encodedSource.replace(/\//g, '_');

              return encodedSource;
          }

          // this function should be in auth server, do not expose your secret
          function generateAccessToken(userName) {
              var header = {
                  "alg": "HS256",
                  "typ": "JWT"
              };

              var stringifiedHeader = CryptoJS.enc.Utf8.parse(JSON.stringify(header));
              var encodedHeader = base64url(stringifiedHeader);

              // customize your JWT token payload here
              var data = {
                  "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/nameidentifier": userName,
                  "exp": 1699819025,
                  'admin': isAdmin
              };

              var stringifiedData = CryptoJS.enc.Utf8.parse(JSON.stringify(data));
              var encodedData = base64url(stringifiedData);

              var token = encodedHeader + "." + encodedData;

              var secret = "myfunctionauthtest"; // do not expose your secret here

              var signature = CryptoJS.HmacSHA256(token, secret);
              signature = base64url(signature);

              var signedToken = token + "." + signature;

              return signedToken;
          }
      </script>
</body>

</html>